<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tr√§dspecialisterna ‚Äì CRM, Offert & Jobbplanering</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- OneSignal SDK (fyll i App ID i scriptet under) -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
  <script>
    // Fyll i ditt OneSignal App ID:
    const ONESIGNAL_APP_ID = "DIN_ONESIGNAL_APP_ID";
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(function () {
      OneSignal.init({
        appId: ONESIGNAL_APP_ID,
        notifyButton: { enable: true } // liten klock-ikon nere i h√∂rnet
      });
    });
  </script>

  <style>
    :root{
      --bg:#070a13; --surface:#0c1424; --elev:#101a31; --line:#20305a; --text:#edf2ff; --dim:#9fb0d6;
      --accent1:#60a5fa; --accent2:#67e8f9; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 90% -10%, rgba(96,165,250,.12), transparent),
                  radial-gradient(900px 600px at -10% 110%, rgba(103,232,249,.12), transparent),
                  var(--bg);
    }
    .hide{display:none !important}
    .container{max-width:1240px;margin:0 auto;padding:12px 16px 24px}
    .header{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .burger{display:none; padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0b162d;color:#cfe1ff;cursor:pointer}
    .logo{font-weight:800;letter-spacing:.2px}
    .logo small{display:block;font-weight:600;color:#b8c7ee}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:linear-gradient(145deg,#0e1730 0%,#0a1426 100%);border:1px solid var(--line);border-radius:18px;box-shadow:0 12px 40px rgba(0,0,0,.35)}
    .pad{padding:18px}
    label{font-size:12px;color:var(--dim);display:block;margin:6px 0}
    input,select,textarea,button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0b162d;color:var(--text)}
    input::placeholder,textarea::placeholder{color:#7f8bb0}
    .btn{cursor:pointer;transition:transform .06s ease, box-shadow .2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#06101f;border:none;font-weight:800}
    .btn.ghost{background:transparent;border:1px dashed var(--line)}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:260px 1fr}
    @media (max-width: 1100px){.grid-2{grid-template-columns:1fr}}
    .sidebar{position:sticky;top:16px;height:calc(100vh - 32px);padding:14px;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#0a1426,#081225)}
    .nav button{display:flex;gap:10px;align-items:center;width:100%;background:transparent;border:1px solid var(--line);border-radius:12px;padding:11px 12px;margin-bottom:10px;color:#d7e7ff}
    .nav button.active{background:linear-gradient(135deg, rgba(96,165,250,.25), rgba(103,232,249,.2));color:#041226}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 280px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0b162d;border:1px solid var(--line);font-size:12px;color:#cfe1ff}
    .badge{border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:11px;color:#cfe1ff}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px;background:#0f1a33}
    .item h4{margin:0 0 6px 0}
    .muted{color:var(--dim);font-size:12px}
    .right{text-align:right}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--line);text-align:left}

    /* Kanban */
    .kanban{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width: 1100px){.kanban{grid-template-columns:1fr 1fr}}
    @media (max-width: 680px){.kanban{grid-template-columns:1fr}}
    .colK{background:#0b162d;border:1px solid var(--line);border-radius:14px;min-height:240px}
    .colK header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--line)}
    .colK .body{padding:12px;display:grid;gap:10px;min-height:160px}
    .ticket{padding:10px;border-radius:12px;background:#0f1a33;border:1px solid var(--line);cursor:grab}
    .ticket:active{cursor:grabbing}
    .dropping{outline:2px dashed var(--accent1);outline-offset:-6px}
    .status{padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}

    /* Prices list */
    .prices{display:grid;gap:8px}
    .price-row{display:grid;grid-template-columns:1fr 140px 40px;gap:8px}
    .price-total{display:flex;justify-content:flex-end;gap:12px;align-items:center}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(2,8,20,.7);display:flex;align-items:center;justify-content:center;padding:20px}
    .modal .box{max-width:840px;width:100%;background:#0b1427;border:1px solid var(--line);border-radius:18px}

    /* Map */
    #map{height:560px;border-radius:16px;border:1px solid var(--line)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:12px;padding:2px 6px;border:1px solid var(--line);border-radius:8px;background:#0b162d}

    /* Mobil: visa endast aktiv sektion och anv√§nd hamburgare */
    @media (max-width: 768px){
      .grid-2{display:block}
      .burger{display:inline-flex}
      .drawer{position:fixed;inset:0 30% 0 0; max-width: 82vw; background:#081225; border-right:1px solid var(--line); padding:16px; transform:translateX(-100%); transition:transform .2s ease; z-index:40;}
      .drawer.open{transform:translateX(0)}
      .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:30}
      main.grid{position:relative}
      main.grid>section{display:none;position:relative}
      main.grid>section.active{display:block}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <button id="burger" class="burger" aria-label="Meny" onclick="toggleDrawer()">‚ò∞</button>
        <div class="logo">Tr√§dspecialisterna <small>Internt CRM ‚Ä¢ Offert ‚Ä¢ Jobbplanering</small></div>
      </div>
      <div class="toolbar">
        <!-- Global s√∂k: p√•verkar alla vyer -->
        <input id="globalSearch" placeholder="S√∂k (namn, tel, personnummer, adress, e-post)" oninput="syncGlobalSearch()" style="min-width:260px">
        <span class="pill">Anv√§ndare: <span id="userEmailTop">‚Äî</span></span>
      </div>
    </div>

    <!-- AUTH / LANDNING ‚Äì login f√∂rst -->
    <section id="authCard" class="card pad" style="margin-top:12px">
      <div class="row">
        <div class="col" style="min-width:320px">
          <h2 style="margin:0 0 6px 0">Logga in</h2>
          <p class="muted">Demo lagrar data lokalt (LocalStorage). I produktion: backend + databas + JWT.</p>
          <label>E-post</label>
          <input id="email" type="email" placeholder="namn@tradspecialisterna.se" />
          <label>L√∂senord</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" onclick="authLogin()">Logga in</button>
            <button class="btn" onclick="authRegister()">Registrera</button>
          </div>
        </div>
        <div class="col" style="display:grid;place-items:center">
          <div style="padding:20px;border:1px solid var(--line);border-radius:16px">
            <div class="toolbar">
              <span class="badge">Kundregister</span>
              <span class="badge">Offert via e-post</span>
              <span class="badge">Kartvy</span>
              <span class="badge">Kanban drag-&-drop</span>
            </div>
            <p class="muted" style="margin-top:10px">Modern, snabb och responsiv CRM-prototyp anpassad f√∂r arboristjobb.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section id="app" class="grid grid-2 hide" style="margin-top:12px">
      <!-- Sidebar / Drawer -->
      <aside id="sidebar" class="sidebar drawer">
        <div class="toolbar" style="justify-content:space-between">
          <span class="pill">Anv√§ndare: <span id="userEmail"></span></span>
          <button class="btn" onclick="logout()">Logga ut</button>
        </div>
        <div class="nav" style="margin-top:14px">
          <button id="navDashboard" class="active" onclick="openSection('dashboard', this)">üè† √ñversikt</button>
          <button onclick="openSection('newCustomer', this)">‚ûï Ny kund</button>
          <button onclick="openSection('customers', this)">üìá Kundregister</button>
          <button onclick="openSection('jobs', this)">üóÇÔ∏è Jobb</button>
          <button onclick="openSection('mapview', this); initMapOnce()">üó∫Ô∏è Kartvy</button>
          <button onclick="openSection('offers', this)">üìß Offert</button>
        </div>
      </aside>

      <main class="grid" style="gap:16px">
        <!-- DASHBOARD -->
        <section id="dashboard" class="card pad active">
          <div class="row" style="align-items:center;justify-content:space-between">
            <h2 style="margin:0">√ñversikt</h2>
            <div class="toolbar">
              <input id="search" placeholder="S√∂k (synkas med f√§ltet i toppen)‚Ä¶" oninput="renderAll()" style="width:260px" />
              <select id="filterStatus" onchange="renderAll()">
                <option value="">Alla status</option>
                <option>Inkomna</option>
                <option>F√•tt pris</option>
                <option>P√•g√•ende</option>
                <option>Klara</option>
              </select>
              <span class="pill">Totalt: <span id="statsTotal">0</span></span>
              <span class="pill">Offert skickad: <span id="statsQuoted">0</span></span>
            </div>
          </div>
          <div class="kanban" style="margin-top:12px">
            <div class="colK" ondragover="allowDrop(event)" ondrop="dropOnCol(event, 'Inkomna')">
              <header><strong>Inkomna</strong><span class="pill" id="count-Inkomna">0</span></header>
              <div class="body" id="col-Inkomna"></div>
            </div>
            <div class="colK" ondragover="allowDrop(event)" ondrop="dropOnCol(event, 'F√•tt pris')">
              <header><strong>F√•tt pris</strong><span class="pill" id="count-F√•tt pris">0</span></header>
              <div class="body" id="col-F√•tt pris"></div>
            </div>
            <div class="colK" ondragover="allowDrop(event)" ondrop="dropOnCol(event, 'P√•g√•ende')">
              <header><strong>P√•g√•ende</strong><span class="pill" id="count-P√•g√•ende">0</span></header>
              <div class="body" id="col-P√•g√•ende"></div>
            </div>
            <div class="colK" ondragover="allowDrop(event)" ondrop="dropOnCol(event, 'Klara')">
              <header><strong>Klara</strong><span class="pill" id="count-Klara">0</span></header>
              <div class="body" id="col-Klara"></div>
            </div>
          </div>
        </section>

        <!-- NEW CUSTOMER -->
        <section id="newCustomer" class="card pad hide">
          <h2 style="margin:0 0 6px 0">Ny kund</h2>
          <p class="muted">Adressf√§ltet anv√§nder Google Places Autocomplete och √§r begr√§nsat till Sverige.</p>
          <div class="row">
            <div class="col">
              <label>Namn</label>
              <input id="c_name" placeholder="Kundens namn" />
            </div>
            <div class="col">
              <label>Personnummer (valfritt)</label>
              <input id="c_ssn" placeholder="√Ö√Ö√Ö√ÖMMDD-XXXX" />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>E-post</label>
              <input id="c_email" type="email" placeholder="kund@mail.se" />
            </div>
            <div class="col">
              <label>Telefon</label>
              <input id="c_phone" placeholder="070-000 00 00" />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>Adress</label>
              <input id="c_address" placeholder="Skriv adress‚Ä¶" />
              <small class="muted">Koordinater h√§mtas automatiskt.</small>
            </div>
            <div class="col">
              <label>Jobbstatus</label>
              <select id="c_status">
                <option>Inkomna</option>
                <option>F√•tt pris</option>
                <option>P√•g√•ende</option>
                <option>Klara</option>
              </select>
            </div>
          </div>

          <div style="margin-top:8px">
            <label>Prisrader</label>
            <div id="prices" class="prices"></div>
            <div class="row">
              <div class="col"><input id="p_desc" placeholder="Beskrivning (t.ex. Tr√§df√§llning)" /></div>
              <div class="col"><input id="p_amount" type="number" placeholder="Belopp (SEK)" /></div>
              <div style="width:80px"><button class="btn" onclick="addPriceRow()">L√§gg till</button></div>
            </div>
            <div class="price-total" style="margin-top:6px"><span class="muted">Summa:</span> <strong id="priceSum">0 kr</strong></div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col">
              <label>Offert skickad?</label>
              <select id="c_quote_sent"><option>Nej</option><option>Ja</option></select>
            </div>
            <div class="col">
              <label>Anteckningar</label>
              <textarea id="c_notes" rows="3" placeholder="Tr√§dtyp, √•tkomst, riskzoner, √∂nskem√•l‚Ä¶"></textarea>
            </div>
          </div>

          <div class="toolbar" style="margin-top:10px">
            <button class="btn primary" onclick="saveCustomer()">Spara kund</button>
            <button class="btn ghost" onclick="clearCustomerForm()">Rensa</button>
          </div>
        </section>

        <!-- CUSTOMERS -->
        <section id="customers" class="card pad hide">
          <div id="customerList" class="list"></div>
        </section>

        <!-- JOBS -->
        <section id="jobs" class="card pad hide">
          <h2 style="margin:0 0 6px 0">Jobbregister</h2>
          <p class="muted">Visar kunder d√§r pris √§r satt eller jobb p√•g√•r/klart. Anv√§nd s√∂k/filtrering.</p>
          <table class="table" id="jobTable">
            <thead>
              <tr>
                <th>Namn</th>
                <th>Adress</th>
                <th>Status</th>
                <th>Offert</th>
                <th class="right">Summa</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- MAP -->
        <section id="mapview" class="card pad hide">
          <div class="row" style="align-items:flex-end">
            <div class="col">
              <label>Filtrera status i kartan</label>
              <select id="mapFilter" onchange="plotMarkers()">
                <option value="">Alla</option>
                <option>Inkomna</option>
                <option>F√•tt pris</option>
                <option>P√•g√•ende</option>
                <option>Klara</option>
              </select>
            </div>
            <div class="col"><span class="muted">Tips: <span class="kbd">‚åò/Ctrl</span> + scroll f√∂r zoom.</span></div>
          </div>
          <div id="map" style="margin-top:12px"></div>
        </section>

        <!-- OFFERS -->
        <section id="offers" class="card pad hide">
          <h2 style="margin:0 0 6px 0">Skicka offert</h2>
          <div class="row">
            <div class="col">
              <label>V√§lj kund</label>
              <select id="offerCustomer" onchange="prefillOffer()"></select>
            </div>
            <div class="col">
              <label>√Ñmne</label>
              <input id="offerSubject" placeholder="Offert ‚Äì Arbete p√• [adress]" />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>Meddelande</label>
              <textarea id="offerBody" rows="10" placeholder="Hej [Namn]

Tack f√∂r f√∂rfr√•gan. H√§r kommer v√•r offert...

Pris: [summa] SEK
Giltig t.o.m. [datum]

V√§nligen,
Tr√§dspecialisterna"></textarea>
            </div>
          </div>
          <div class="toolbar" style="margin-top:10px">
            <button class="btn" onclick="markQuoteSent()">Markera som skickad</button>
            <button class="btn primary" onclick="composeMailto()">Skicka sp√•rbar offert (mailto-backup)</button>
          </div>
          <p class="muted" style="margin-top:6px">OBS: F√∂r full sp√•rning (accept/nej via l√§nk + push) beh√∂vs backend-URL:er. Denna knapp anv√§nder e-postklienten med l√§nkar i br√∂dtexten.</p>
        </section>
      </main>
    </section>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="modal hide">
    <div class="box pad">
      <div class="row" style="align-items:center;justify-content:space-between">
        <h3 style="margin:0">Redigera kund</h3>
        <button class="btn" onclick="closeEdit()">St√§ng</button>
      </div>
      <div class="row">
        <div class="col"><label>Namn</label><input id="e_name"></div>
        <div class="col"><label>Personnummer</label><input id="e_ssn"></div>
      </div>
      <div class="row">
        <div class="col"><label>E-post</label><input id="e_email"></div>
        <div class="col"><label>Telefon</label><input id="e_phone"></div>
      </div>
      <div class="row">
        <div class="col"><label>Adress</label><input id="e_address"></div>
        <div class="col"><label>Status</label>
          <select id="e_status"><option>Inkomna</option><option>F√•tt pris</option><option>P√•g√•ende</option><option>Klara</option></select>
        </div>
      </div>
      <div class="row">
        <div class="col"><label>Offert skickad?</label><select id="e_quote_sent"><option>Nej</option><option>Ja</option></select></div>
        <div class="col"><label>Anteckningar</label><textarea id="e_notes" rows="3"></textarea></div>
      </div>
      <div style="margin-top:10px">
        <label>Prisrader</label>
        <div id="e_prices" class="prices"></div>
        <div class="row">
          <div class="col"><input id="e_p_desc" placeholder="Beskrivning" /></div>
          <div class="col"><input id="e_p_amount" type="number" placeholder="Belopp (SEK)" /></div>
          <div style="width:80px"><button class="btn" onclick="editAddPriceRow()">L√§gg till</button></div>
        </div>
        <div class="price-total"><span class="muted">Summa:</span> <strong id="e_priceSum">0 kr</strong></div>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <button class="btn primary" onclick="saveEdit()">Spara</button>
        <button class="btn ghost" onclick="closeEdit()">Avbryt</button>
      </div>
    </div>
  </div>

  <script>
    // ======= STATE =======
    const state={
      currentUser:null,
      customers: JSON.parse(localStorage.getItem('ts_customers')||'[]'),
      map:null, markers:[], editIndex:null, acNew:null, acEdit:null
    };
    function persist(){ localStorage.setItem('ts_customers', JSON.stringify(state.customers)); }
    const uuidv4 = () => (typeof crypto!=='undefined' && crypto.randomUUID ? crypto.randomUUID() : ('id-'+Math.random().toString(36).slice(2)));

    // ======= AUTH =======
    function authLogin(){
      const email=document.getElementById('email').value.trim();
      if(!email) return alert('Fyll i e-post');
      state.currentUser=email;
      document.getElementById('authCard').classList.add('hide');
      document.getElementById('app').classList.remove('hide');
      document.getElementById('userEmail').textContent=email;
      document.getElementById('userEmailTop').textContent=email;
      openSection('dashboard', document.getElementById('navDashboard'));
      renderAll(); refreshOfferList();
    }
    function authRegister(){ alert('Registrering i denna demo √§r lokal. Anv√§nd backend i produktion.'); }
    function logout(){ location.reload(); }

    // ======= HAMBURGER / DRAWER =======
    let drawerOpen=false;
    function toggleDrawer(){
      drawerOpen=!drawerOpen;
      const sb=document.getElementById('sidebar');
      if(!sb) return;
      sb.classList.toggle('open', drawerOpen);
      if(drawerOpen){
        const back=document.createElement('div'); back.className='backdrop'; back.id='backdrop';
        back.onclick=toggleDrawer; document.body.appendChild(back);
      }else{
        document.getElementById('backdrop')?.remove();
      }
    }

    // ======= NAVIGATION =======
    function openSection(id,btn){
      // st√§ng menyn p√• mobil n√§r man v√§ljer
      if(drawerOpen) toggleDrawer();

      for(const sec of ['dashboard','newCustomer','customers','jobs','mapview','offers']){
        const el=document.getElementById(sec);
        if(el){
          const isActive = (sec===id);
          el.classList.toggle('hide', !isActive);
          if(isActive) el.classList.add('active'); else el.classList.remove('active');
        }
      }
      document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
      if(btn) btn.classList.add('active');
      if(id==='mapview') initMapOnce();
    }

    // ======= GLOBAL S√ñK =======
    function syncGlobalSearch(){
      const q=document.getElementById('globalSearch').value || '';
      const local=document.getElementById('search');
      if(local) local.value=q;
      renderAll();
    }

    // ======= PRICE HELPERS (NEW) =======
    let tempPrices=[]; // for the create form
    function sumAmounts(list){ return (list||[]).reduce((n,p)=>n+(Number(p.amount)||0),0); }
    function addPriceRow(){
      const d=document.getElementById('p_desc').value.trim();
      const a=Number(document.getElementById('p_amount').value||0);
      if(!d || !a) return;
      tempPrices.push({desc:d, amount:a});
      document.getElementById('p_desc').value=''; document.getElementById('p_amount').value='';
      renderPriceList('prices','priceSum',tempPrices);
    }
    function removePriceRow(idx){ tempPrices.splice(idx,1); renderPriceList('prices','priceSum',tempPrices); }
    function renderPriceList(containerId,sumId,list){
      const wrap=document.getElementById(containerId); if(!wrap) return; wrap.innerHTML='';
      list.forEach((p,i)=>{
        const row=document.createElement('div'); row.className='price-row';
        row.innerHTML=`<input value="${p.desc}" oninput="tempPrices[${i}].desc=this.value" />
                       <input type="number" value="${p.amount}" oninput="tempPrices[${i}].amount=Number(this.value||0); updateSum('${sumId}', tempPrices)" />
                       <button class="btn" onclick="removePriceRow(${i})">‚úï</button>`;
        wrap.appendChild(row);
      });
      updateSum(sumId, list);
    }
    function updateSum(sumId,list){ const s=sumAmounts(list); const el=document.getElementById(sumId); if(el) el.textContent=s.toLocaleString('sv-SE')+' kr'; }

    // ======= CREATE CUSTOMER =======
    function val(x){ const el=document.getElementById(x); return el? (el.value||'') : ''; }
    function clearCustomerForm(){ ['c_name','c_ssn','c_email','c_phone','c_address','c_notes'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      document.getElementById('c_status').value='Inkomna'; document.getElementById('c_quote_sent').value='Nej'; tempPrices=[]; renderPriceList('prices','priceSum',tempPrices);
    }
    function saveCustomer(){
      const c={
        id: uuidv4(),
        name: val('c_name'), ssn: val('c_ssn'), email: val('c_email'), phone: val('c_phone'),
        address: val('c_address'), status: val('c_status'), quote_sent: val('c_quote_sent'),
        notes: val('c_notes'),
        priceItems: [...tempPrices],
        price: sumAmounts(tempPrices),
        lat: lastNewPlace?.lat||null, lng: lastNewPlace?.lng||null,
        createdAt: Date.now(),
        quote_status: (val('c_quote_sent')==='Ja'?'sent': 'sent') // plats f√∂r sp√•rad status
      };
      if(!c.name||!c.address){ alert('Namn och adress kr√§vs'); return; }
      state.customers.push(c); persist();
      clearCustomerForm(); renderAll(); openSection('customers', document.querySelectorAll('.nav button')[2]);
    }

    // ======= LISTS & TABLES =======
    function fmt(n){ n=Number(n||0); return n.toLocaleString('sv-SE'); }
    function filteredCustomers(){
      const q=(document.getElementById('search')?.value||'').toLowerCase();
      const fs=(document.getElementById('filterStatus')?.value||'');
      return state.customers.filter(c=>{
        const okStatus=!fs||c.status===fs;
        const s=(c.name+' '+(c.phone||'')+' '+(c.ssn||'')+' '+(c.address||'')+' '+(c.email||'')+' '+(c.status||'')).toLowerCase();
        return okStatus && s.includes(q);
      });
    }

    function renderCustomers(){
      const wrap=document.getElementById('customerList'); if(!wrap) return; wrap.innerHTML='';
      const arr=filteredCustomers();
      arr.forEach(c=>{
        const div=document.createElement('div'); div.className='item';
        div.draggable=true; div.ondragstart=(e)=>dragStart(e,c.id);
        const offerBadge = c.quote_status==='accepted' ? '‚úÖ Accepterad' : c.quote_status==='declined' ? '‚ùå Avb√∂jd' : (c.quote_sent||'Nej');
        div.innerHTML=`<h4>${c.name}</h4>
          <div class="muted">${c.address}</div>
          <div class="toolbar" style="margin:8px 0">
            <span class="status">${c.status||'‚Äì'}</span>
            <span class="pill">Offert: ${offerBadge}</span>
            <span class="pill">Summa: ${fmt(c.price)} kr</span>
          </div>
          <div class="muted">${(c.email||'')+(c.phone? ' ‚Ä¢ '+c.phone:'')}</div>
          <div class="toolbar" style="margin-top:10px">
            <button class="btn" onclick="openEditById('${c.id}')">Redigera</button>
            <button class="btn ghost" onclick="prefillOfferFromId('${c.id}')">Skicka offert</button>
            <button class="btn" onclick="focusOnMapById('${c.id}')">Visa p√• karta</button>
          </div>`;
        wrap.appendChild(div);
      });
    }

    function renderJobs(){
      const tbody=document.querySelector('#jobTable tbody'); if(!tbody) return; tbody.innerHTML='';
      const arr=state.customers.filter(c=>['F√•tt pris','P√•g√•ende','Klara'].includes(c.status||''));
      const q=(document.getElementById('search')?.value||'').toLowerCase(); const fs=(document.getElementById('filterStatus')?.value||'');
      arr.filter(c=>{
        const okStatus=!fs||c.status===fs; const s=(c.name+' '+c.address+' '+(c.email||'')+' '+(c.phone||'')+' '+(c.ssn||'')+' '+(c.status||'')).toLowerCase();
        return okStatus && s.includes(q);
      }).forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${c.name}</td><td>${c.address}</td><td>${c.status}</td><td>${c.quote_status==='accepted'?'‚úÖ Accepterad':c.quote_status==='declined'?'‚ùå Avb√∂jd':(c.quote_sent||'Nej')}</td><td class="right">${fmt(c.price)} kr</td>
          <td class="right"><button class="btn" onclick="openEditById('${c.id}')">‚úèÔ∏è</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderDashboard(){
      const cols={'Inkomna':[], 'F√•tt pris':[], 'P√•g√•ende':[], 'Klara':[]};
      const arr=filteredCustomers();
      arr.forEach(c=>{ (cols[c.status||'Inkomna']||cols['Inkomna']).push(c); });
      let quoted=0; arr.forEach(c=>{ if((c.quote_sent||'Nej')==='Ja' || c.quote_status==='accepted' || c.quote_status==='declined') quoted++; });
      document.getElementById('statsTotal').textContent=arr.length;
      document.getElementById('statsQuoted').textContent=quoted;
      for(const k of Object.keys(cols)){
        const body=document.getElementById('col-'+k.replace(' ','-')) || document.getElementById('col-'+k);
      }
      // render bodies
      const colIds={'Inkomna':'col-Inkomna','F√•tt pris':'col-F√•tt pris','P√•g√•ende':'col-P√•g√•ende','Klara':'col-Klara'};
      const countIds={'Inkomna':'count-Inkomna','F√•tt pris':'count-F√•tt pris','P√•g√•ende':'count-P√•g√•ende','Klara':'count-Klara'};
      for(const k of Object.keys(cols)){
        const body=document.getElementById(colIds[k]); const count=document.getElementById(countIds[k]);
        if(body){ body.innerHTML=''; cols[k].forEach(c=>{
          const d=document.createElement('div'); d.className='ticket'; d.draggable=true; d.ondragstart=(e)=>dragStart(e,c.id);
          const badge = c.quote_status==='accepted'?'‚úÖ':c.quote_status==='declined'?'‚ùå':(c.quote_sent||'Nej');
          d.innerHTML=`<div style="font-weight:700">${c.name}</div><div class="muted">${c.address}</div><div class="muted">${fmt(c.price)} kr ‚Ä¢ Offert: ${badge}</div>`;
          body.appendChild(d);
        }); if(count) count.textContent=cols[k].length; }
      }
    }

    function renderAll(){ renderCustomers(); renderJobs(); renderDashboard(); refreshOfferList(); plotMarkers(); }

    // ======= DRAG & DROP =======
    let dragId=null;
    function dragStart(e,id){ dragId=id; e.dataTransfer.setData('text/plain', id); }
    function allowDrop(e){ e.preventDefault(); e.currentTarget.classList.add('dropping'); }
    function dropOnCol(e,status){ e.preventDefault(); e.currentTarget.classList.remove('dropping');
      const idd=e.dataTransfer.getData('text/plain')||dragId; const c=state.customers.find(x=>x.id===idd); if(!c) return;
      c.status=status; persist(); renderAll(); }

    // ======= EDIT MODAL =======
    let tempEditPrices=[];
    function openEditById(idc){ state.editIndex=state.customers.findIndex(x=>x.id===idc); openEdit(state.editIndex); }
    function openEdit(i){ const c=state.customers[i]; if(!c) return; show('editModal');
      id('e_name').value=c.name||''; id('e_ssn').value=c.ssn||''; id('e_email').value=c.email||''; id('e_phone').value=c.phone||'';
      id('e_address').value=c.address||''; id('e_status').value=c.status||'Inkomna'; id('e_quote_sent').value=c.quote_sent||'Nej'; id('e_notes').value=c.notes||'';
      tempEditPrices=c.priceItems? JSON.parse(JSON.stringify(c.priceItems)) : []; renderEditPriceList();
      setupAutocompleteEdit();
    }
    function renderEditPriceList(){ const wrap=id('e_prices'); if(!wrap) return; wrap.innerHTML='';
      tempEditPrices.forEach((p,i)=>{
        const row=document.createElement('div'); row.className='price-row';
        row.innerHTML=`<input value="${p.desc}" oninput="tempEditPrices[${i}].desc=this.value" />
                       <input type="number" value="${p.amount}" oninput="tempEditPrices[${i}].amount=Number(this.value||0); updateSum('e_priceSum', tempEditPrices)" />
                       <button class="btn" onclick="editRemovePriceRow(${i})">‚úï</button>`;
        wrap.appendChild(row);
      });
      updateSum('e_priceSum', tempEditPrices);
    }
    function editAddPriceRow(){ const d=id('e_p_desc').value.trim(); const a=Number(id('e_p_amount').value||0); if(!d||!a) return; tempEditPrices.push({desc:d,amount:a}); id('e_p_desc').value=''; id('e_p_amount').value=''; renderEditPriceList(); }
    function editRemovePriceRow(i){ tempEditPrices.splice(i,1); renderEditPriceList(); }
    function saveEdit(){ const i=state.editIndex; if(i==null) return; const c=state.customers[i];
      c.name=val('e_name'); c.ssn=val('e_ssn'); c.email=val('e_email'); c.phone=val('e_phone'); c.address=val('e_address'); c.status=val('e_status'); c.quote_sent=val('e_quote_sent'); c.notes=val('e_notes');
      c.priceItems=[...tempEditPrices]; c.price=sumAmounts(tempEditPrices);
      persist(); hide('editModal'); renderAll();
    }
    function closeEdit(){ hide('editModal'); }

    // ======= OFFERS =======
    function id(x){ return document.getElementById(x); }
    function show(x){ id(x).classList.remove('hide'); }
    function hide(x){ id(x).classList.add('hide'); }

    function buildOfferSubject(c){ return `Offert ‚Äì Arbete p√• ${c.address}`; }
    function buildOfferBody(c){
      const rows=(c.priceItems||[]).map(p=>`‚Ä¢ ${p.desc}: ${fmt(p.amount)} kr`).join('\n');
      return `Hej ${c.name},\n\nTack f√∂r f√∂rfr√•gan. Vi erbjuder f√∂ljande arbete:\n${rows ? rows+'\n' : ''}\nTotalsumma: ${fmt(c.price)} kr\nGiltig t.o.m. ${new Date(Date.now()+1000*60*60*24*14).toLocaleDateString('sv-SE')}\n\n√Öterkom g√§rna om du har fr√•gor.\n\nV√§nligen,\nTr√§dspecialisterna`;
    }
    function refreshOfferList(){ const sel=id('offerCustomer'); if(!sel) return; sel.innerHTML=''; state.customers.forEach((c)=>{
      const o=document.createElement('option'); o.value=c.id; o.textContent=c.name+' ‚Äì '+c.address; sel.appendChild(o);
    }); if(state.customers.length) prefillOffer(); }
    function prefillOffer(){ const idc=id('offerCustomer').value; const c=state.customers.find(x=>x.id===idc); if(!c) return;
      id('offerSubject').value=buildOfferSubject(c);
      id('offerBody').value=buildOfferBody(c);
    }
    function prefillOfferFromId(idc){ id('offerCustomer').value=idc; prefillOffer(); openSection('offers', document.querySelectorAll('.nav button')[5]); }
    function composeMailto(){ const idc=id('offerCustomer').value; const c=state.customers.find(x=>x.id===idc); if(!c) return alert('V√§lj kund');
      const subject=encodeURIComponent(id('offerSubject').value||'Offert ‚Äì Tr√§dspecialisterna');
      const body=encodeURIComponent(id('offerBody').value||'');
      const to=encodeURIComponent(c.email||'');
      window.location.href=`mailto:${to}?subject=${subject}&body=${body}`;
    }
    function markQuoteSent(){ const idc=id('offerCustomer').value; const c=state.customers.find(x=>x.id===idc); if(!c) return; c.quote_sent='Ja'; persist(); renderAll(); alert('Markerad som skickad'); }

    // ======= MAP & AUTOCOMPLETE =======
    let lastNewPlace=null;
    function initMapOnce(){ if(state.map){ plotMarkers(); return; } if(!id('map')) return; try{ state.map=new google.maps.Map(id('map'),{center:{lat:57.6,lng:11.9},zoom:8}); plotMarkers(); }catch(err){ console.warn('Map init failed:', err); } }
    function plotMarkers(){ if(!state.map || typeof google==='undefined' || !google.maps) return; state.markers.forEach(m=>m.setMap(null)); state.markers=[];
      const fs=id('mapFilter')?.value||''; const arr=state.customers.filter(c=>!fs||c.status===fs);
      arr.forEach(c=>{ if(c.lat && c.lng){ const m=new google.maps.Marker({position:{lat:c.lat,lng:c.lng},map:state.map,title:c.name});
        const inf=new google.maps.InfoWindow({content:`<strong>${c.name}</strong><br>${c.address}<br>Status: ${c.status}<br>Summa: ${fmt(c.price)} kr`});
        m.addListener('click',()=>inf.open({anchor:m,map:state.map})); state.markers.push(m); }});
      if(arr.some(c=>c.lat&&c.lng)){
        const b=new google.maps.LatLngBounds(); arr.forEach(c=>{ if(c.lat&&c.lng) b.extend({lat:c.lat,lng:c.lng}); });
        state.map.fitBounds(b);
      }
    }
    function focusOnMapById(idc){ openSection('mapview', document.querySelectorAll('.nav button')[4]); initMapOnce(); const c=state.customers.find(x=>x.id===idc); if(!c||!c.lat) return; state.map.setCenter({lat:c.lat,lng:c.lng}); state.map.setZoom(14); }

    function setupAutocompleteNew(){ const inp=id('c_address'); if(!inp || typeof google==='undefined' || !google.maps?.places) return; state.acNew=new google.maps.places.Autocomplete(inp,{ componentRestrictions:{ country:['se'] } }); state.acNew.addListener('place_changed',()=>{
      const place=state.acNew.getPlace(); const loc=place.geometry?.location; if(loc){ lastNewPlace={lat:loc.lat(), lng:loc.lng()}; }
    }); }
    function setupAutocompleteEdit(){ const e=id('e_address'); if(!e || typeof google==='undefined' || !google.maps?.places) return; if(state.acEdit){ return; }
      state.acEdit=new google.maps.places.Autocomplete(e,{ componentRestrictions:{ country:['se'] } }); state.acEdit.addListener('place_changed',()=>{
        const p=state.acEdit.getPlace(); const l=p.geometry?.location; if(l && state.editIndex!=null){ const c=state.customers[state.editIndex]; c.lat=l.lat(); c.lng=l.lng(); persist(); }
      }); }

    // ======= HELPERS =======
    function id(x){ return document.getElementById(x); }
    function show(x){ id(x).classList.remove('hide'); }
    function hide(x){ id(x).classList.add('hide'); }

    // Boot
    window.addEventListener('DOMContentLoaded',()=>{
      renderPriceList('prices','priceSum',tempPrices);
    });
    // G√∂r Maps-callback global
    window.setupAutocompleteNew = setupAutocompleteNew;
  </script>

  <!-- GOOGLE MAPS + PLACES (din nyckel inbakad, begr√§nsad till Sverige via autocomplete) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBqrUdXxf3E0HuX408ysi61jTe5I4zmlr4&libraries=places&callback=setupAutocompleteNew"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lösenord & kort — lokalt valv</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#111315; --card:#1a1d21; --press:#171a1d;
    --text:#eef2f6; --muted:#aeb6bf; --accent:#ffd54f; --focus:#5bb0ff;
    --border:#2a2f36; --shadow:0 10px 25px rgba(0,0,0,.35),0 2px 6px rgba(0,0,0,.3);
    --err:#ff8a8a;
  }
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
  .gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#0f1113,#14171a);z-index:9999}
  .panel{width:min(520px,94vw);background:#161a1f;border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:20px}
  .panel h1{margin:4px 0 10px;font-size:22px}
  .muted{color:var(--muted);font-size:13px}
  .label{font-weight:600;margin-top:10px}
  .field{display:flex;gap:8px;margin:8px 0}
  .field input,.field textarea{flex:1;background:#0f1215;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:12px;font-size:15px}
  .field input.error{border-color:#7a2a2a; box-shadow:0 0 0 3px rgba(255,138,138,.12)}
  .errline{display:none;color:var(--err);font-size:13px;margin-top:8px}
  .row{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;margin-top:10px}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#1a1d21;border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;user-select:none;transition:.15s;box-shadow:var(--shadow);font-weight:600}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0);background:var(--press)}
  .btn-accent{border-color:#7a5f00;background:linear-gradient(180deg,#1e1a12,#17140e);color:#ffd54f}
  .pill{background:#20242a;border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-size:13px;cursor:pointer}
  .app{max-width:1100px;margin:0 auto;padding:16px 16px 96px}
  .topbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(17,19,21,.95) 60%,rgba(17,19,21,0));backdrop-filter:blur(8px);padding:12px 16px 10px;margin:0 -16px 12px;border-bottom:1px solid var(--border)}
  .headline{display:flex;gap:12px;align-items:center}
  .dot{width:18px;height:18px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 4px rgba(255,213,79,.12)}
  .title{font-size:22px;font-weight:700}
  .subtitle{color:var(--muted);font-size:13px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .search{flex:1 1 360px;display:flex;align-items:center;gap:8px;background:#1a1d21;border:1px solid var(--border);border-radius:999px;padding:10px 14px}
  .search input{background:transparent;border:0;outline:none;color:var(--text);width:100%;font-size:15px}
  .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px;margin-top:14px}
  @media(min-width:680px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:1024px){.grid{grid-template-columns:repeat(3,1fr)}}
  .card{background:#1a1d21;border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
  .card-head{display:flex;gap:12px;align-items:center;margin-bottom:8px}
  .favicon{width:22px;height:22px;border-radius:6px;background:#2a2f36;object-fit:cover}
  .badge{margin-left:auto;background:#23272d;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px;color:#aeb6bf}
  .kv{display:grid;grid-template-columns:110px 1fr;gap:6px 10px;font-size:14px;margin:8px 0 12px}
  .kv .k{color:#aeb6bf}
  .kv .v{min-width:0;overflow-wrap:anywhere;word-break:break-word}
  .kv input,.kv textarea{width:100%;max-width:100%;background:#14171a;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:9px 10px;font-size:14px}
  .row-actions{display:flex;gap:8px;flex-wrap:wrap}
  .empty{text-align:center;padding:36px;border:1px dashed var(--border);border-radius:14px;color:#aeb6bf}
  .footer{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);color:#8c96a3;font-size:12px;opacity:.75}
</style>
</head>
<body>

<!-- GATE -->
<div id="gate" class="gate" aria-live="polite">
  <div class="panel">
    <h1 id="gateTitle">Nytt huvudlösenord</h1>
    <div id="gateDesc" class="muted">Välj ett huvudlösenord. Det krävs för att öppna valvet i framtiden.</div>

    <!-- Onboarding steg 1 -->
    <div id="onb">
      <div class="label">Lösenord <span class="muted">(minst 8 tecken)</span></div>
      <div class="field"><input id="mp1" type="password" placeholder="Minst 8 tecken" autocomplete="new-password"></div>
      <div class="label">Bekräfta lösenord</div>
      <div class="field"><input id="mp2" type="password" placeholder="Repetera lösenord" autocomplete="new-password"></div>
      <div class="label">Återställnings-e-post</div>
      <div class="field"><input id="mpEmail" type="email" placeholder="namn@exempel.se" autocomplete="email"></div>
    </div>

    <!-- Onboarding steg 2: återställningsnyckel -->
    <div id="recoveryStep" style="display:none">
      <div class="muted">Spara din <b>återställningsnyckel</b> (krävs om du glömmer lösenordet):</div>
      <div id="recoveryKey" style="margin:8px 0;padding:10px;border:1px dashed #39424d;border-radius:10px;word-break:break-word;font-family:ui-monospace,Menlo,monospace"></div>
      <div class="row" style="justify-content:flex-start">
        <span class="pill" id="copyKey">Kopiera</span>
        <span class="pill" id="downloadKey">Ladda ned</span>
        <span class="pill" id="emailKey">Maila nyckel</span>
      </div>
    </div>

    <!-- Login -->
    <div id="login" style="display:none">
      <div class="label">Huvudlösenord</div>
      <div class="field"><input id="mp" type="password" placeholder="Skriv ditt huvudlösenord" autocomplete="current-password"></div>
      <div class="row" style="justify-content:flex-start"><a href="#" id="forgotBtn" class="muted">Glömt lösenord?</a></div>
    </div>

    <!-- Återställ -->
    <div id="resetForm" style="display:none;margin-top:10px">
      <div class="muted" style="margin-bottom:6px">Återställ med e-post + återställningsnyckel.</div>
      <div class="label">E-post</div><div class="field"><input id="resetEmail" type="email"></div>
      <div class="label">Återställningsnyckel</div><div class="field"><textarea id="resetKey" rows="3"></textarea></div>
      <div class="label">Nytt lösenord (minst 8)</div><div class="field"><input id="resetNew1" type="password"></div>
      <div class="label">Bekräfta nytt lösenord</div><div class="field"><input id="resetNew2" type="password"></div>
      <div class="row"><button class="btn" id="cancelReset">Avbryt</button><button class="btn btn-accent" id="applyReset">Återställ</button></div>
    </div>

    <div id="err" class="errline"></div>
    <div class="row">
      <button class="btn btn-accent" id="primaryBtn" type="button">Skapa valv</button>
      <a href="#" id="factoryReset" class="muted" style="margin-left:auto">Återställ appen</a>
    </div>
  </div>
</div>

<!-- APP -->
<div class="app" id="app" aria-hidden="true">
  <div class="topbar">
    <div class="headline">
      <div class="dot"></div>
      <div>
        <div class="title">Lösenord & kort</div>
        <div class="subtitle">Krypterat lokalt i din webbläsare</div>
      </div>
    </div>
    <div class="toolbar">
      <label class="search" title="Sök (träffar överst, markerade)">
        <input id="q" placeholder="Sök…" autocomplete="off"/>
      </label>
      <button class="btn" id="btnImportVault">Importera .vault<input id="fileVault" type="file" accept=".vault,.json" hidden></button>
      <button class="btn" id="btnExportVault">Exportera .vault</button>
      <button class="btn btn-accent" id="btnAdd">Nytt kort</button>
      <button class="btn" id="btnLock" title="Lås nu">Lås</button>
    </div>
  </div>

  <div id="cards" class="grid" aria-live="polite"></div>
  <div id="empty" class="empty" style="display:none">Inga poster än. Skapa ett kort eller importera .vault.</div>
  <div class="footer">Autolås vid inaktivitet och när fliken döljs. Urklipp rensas efter 15 sek.</div>
</div>

<!-- Modal: Nytt/Redigera -->
<div class="gate" id="modalBackdrop" style="display:none;z-index:998;align-items:center;justify-content:center;background:rgba(0,0,0,.55)">
  <div class="panel" style="width:min(640px,94vw)">
    <h1 id="modalTitle" style="font-size:20px">Nytt kort</h1>
    <div class="kv" style="margin-top:6px">
      <div class="k">Titel / Sajt</div><div class="v"><input id="f_title" placeholder="t.ex. Google"></div>
      <div class="k">Användarnamn</div><div class="v"><input id="f_user" placeholder="t.ex. mail@exempel.se"></div>
      <div class="k">Lösenord</div>
      <div class="v">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="f_pass" type="text" placeholder="••••••" style="flex:1">
          <span class="pill" id="toggleEditPw">Dölj</span>
          <span class="pill" id="copyEditPw">Kopiera</span>
          <span class="pill" id="genPw" title="Generera starkt">Generera</span>
        </div>
      </div>
      <div class="k">URL</div><div class="v"><input id="f_url" placeholder="https://…"></div>
      <div class="k">Anteckning</div><div class="v"><textarea id="f_note" rows="3" placeholder="Valfritt"></textarea></div>
    </div>
    <div class="row"><button class="btn" id="btnCancel">Avbryt</button><button class="btn btn-accent" id="btnSave">Spara</button></div>
  </div>
</div>

<!-- Inbäddad CryptoJS (PBKDF2/AES/Base64) – för offline-fallback -->
<script>
/*! CryptoJS v4.1.1 (utdrag minifierat för AES/PBKDF2/Base64) */
var CryptoJS=CryptoJS||function(u,l){var d={},n=d.lib={},p=function(){},s=n.Base={extend:function(a){p.prototype=this;var c=new p;a&&c.mixIn(a);c.hasOwnProperty("init")||(c.init=function(){c.$super.init.apply(this,arguments)});c.init.prototype=c;c.$super=this;return c},create:function(){var a=this.extend();a.init.apply(a,arguments);return a},init:function(){},mixIn:function(a){for(var c in a)a.hasOwnProperty(c)&&(this[c]=a[c]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},
q=n.WordArray=s.extend({init:function(a,c){a=this.words=a||[];this.sigBytes=c!=l?c:4*a.length},toString:function(a){return(a||v).stringify(this)},concat:function(a){var c=this.words,m=a.words,f=this.sigBytes;a=a.sigBytes;this.clamp();if(f%4)for(var t=0;t<a;t++)c[f+t>>>2]|=(m[t>>>2]>>>24-8*(t%4)&255)<<24-8*((f+t)%4);else if(65535<m.length)for(t=0;t<a;t+=4)c[f+t>>>2]=m[t>>>2];else c.push.apply(c,m);this.sigBytes+=a;return this},clamp:function(){var a=this.words,c=this.sigBytes;a[c>>>2]&=4294967295<<32-8*(c%4);a.length=u.ceil(c/4)},clone:function(){var a=s.clone.call(this);a.words=this.words.slice(0);return a},random:function(a){for(var c=[],m=0;m<a;m+=4)c.push(4294967296*u.random()|0);return new q.init(c,a)}}),w=d.enc={},v=w.Hex={stringify:function(a){var c=a.words;a=a.sigBytes;for(var m=[],f=0;f<a;f++){var t=c[f>>>2]>>>24-8*(f%4)&255;m.push((t>>>4).toString(16));m.push((t&15).toString(16))}return m.join("")},parse:function(a){for(var c=a.length,m=[],f=0;f<c;f+=2)m[f>>>3]|=parseInt(a.substr(f,2),16)<<24-4*(f%8);return new q.init(m,c/2)}},b=w.Base64={stringify:function(a){var c=a.words,m=a.sigBytes,f=this._map;a.clamp();a=[];for(var t=0;t<m;t+=3)for(var r=(c[t>>>2]>>>24-8*(t%4)&255)<<16|(c[t+1>>>2]>>>24-8*((t+1)%4)&255)<<8|c[t+2>>>2]>>>24-8*((t+2)%4)&255,e=0;4>e&&t+0.75*e<m;e++)a.push(f.charAt(r>>>6*(3-e)&63));if(c=f.charAt(64))for(;a.length%4;)a.push(c);return a.join("")},parse:function(a){var c=a.length,h=this._map,m=h.charAt(64);m&&(m=a.indexOf(m),-1!=m&&(c=m));for(var m=[],f=0,t=0;t<c;t++)if(t%4){var r=h.indexOf(a.charAt(t-1))<<2*(t%4),e=h.indexOf(a.charAt(t))>>>6-2*(t%4);m[f>>>2]|=(r|e)<<24-8*(f%4);f++}return q.create(m,f)},_map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="};
w.Utf8={stringify:function(a){try{return decodeURIComponent(escape(v.stringify(a)))}catch(c){throw Error("Malformed UTF-8 data");}},parse:function(a){return v.parse(unescape(encodeURIComponent(a)))}};
var x=n.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=q.create();this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=w.Utf8.parse(a));this._data.concat(a);this._nDataBytes+=a.sigBytes},_process:function(a){var c=this._data,m=c.words,f=c.sigBytes,h=this.blockSize,t=f/(4*h),t=a?u.ceil(t):u.max((t|0)-this._minBufferSize,0);a=t*h;f=u.min(4*a,f);if(a){for(var r=0;r<a;r+=h)this._doProcessBlock(m,r);r=m.splice(0,a);c.sigBytes-=f}return q.create(r,f)},clone:function(){var a=s.clone.call(this);a._data=this._data.clone();return a},_minBufferSize:0});
n.Hasher=x.extend({cfg:s.extend(),init:function(a){this.cfg=this.cfg.extend(a);this.reset()},reset:function(){x.reset.call(this);this._doReset()},update:function(a){this._append(a);this._process();return this},finalize:function(a){a&&this._append(a);return this._doFinalize()},blockSize:16,createHelper:function(a){return function(c,m){return(new a.init(m)).finalize(c)}},createHmacHelper:function(a){return function(c,m){return(new y.HMAC.init(a,m)).finalize(c)}}});var y=d.algo={};
(function(){var a=y.SHA256=n.Hasher.extend({_doReset:function(){this._hash=q.create([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225])},_doProcessBlock:function(a,c){for(var m=this._hash.words,f=m[0],h=m[1],t=m[2],r=m[3],e=m[4],g=m[5],k=m[6],n=m[7],b=0;64>b;b++){var d=a[c+b]|0;var l=n+(e>>>6^e>>>11^e>>>25)+(e&g^~e&k)+Math.floor(4294967296*u.abs(u.sin(b+1)))+d|0;var s=(f>>>2^f>>>13^f>>>22)+(f&h^f&t^h&t)|0;r=r+l|0;var o=((h>>>10^h>>>19^h>>>29)+((h&f)^(h&t)^(f&t)))|0;f=f+(s+r)|0}m[0]=m[0]+f|0;m[1]=m[1]+h|0;m[2]=m[2]+t|0;m[3]=m[3]+r|0;m[4]=m[4]+e|0;m[5]=m[5]+g|0;m[6]=m[6]+k|0;m[7]=m[7]+n|0},_doFinalize:function(){return this._hash},clone:function(){var a=n.Hasher.clone.call(this);a._hash=this._hash.clone();return a}})();
d.PBKDF2=function(a,c,m){m=m||{};var f=n.algo.SHA256,t=m.hasher||f,r=m.keySize||8,e=m.iterations||1;var g=CryptoJS.algo.HMAC.create(t,c);var k=q.create();for(var i=1;i<=r;i++){var h=q.create([0,0,0,i]);g.reset();var o=g.update(a).finalize(h);for(var j=1;j<e;j++)g.reset(),o=g.finalize(o);k.concat(o)}k.sigBytes=4*r;return k};
(function(){var a=CryptoJS,c=a.lib,m=c.BlockCipher,f=a.algo,t=[],r=[],e=[],g=[],k=[],n=[],b=[],d=[],l=[],p=[];(function(){for(var a=[],c=0;256>c;c++)a[c]=128>c?c<<1:c<<1^283;for(var m=0,f=0,c=0;256>c;c++){var h=f^f<<1^f<<2^f<<3^f<<4,h=h>>>8^h&255^99;t[m]=h;r[h]=m;var q=a[m],A=a[q],B=a[A],C=257*a[h]^16843008*h;e[m]=C<<24|C>>>8;g[m]=C<<16|C>>>16;k[m]=C<<8|C>>>24;n[m]=C;C=16843009*B^65537*A^257*q^16843008*m;b[h]=C<<24|C>>>8;d[h]=C<<16|C>>>16;l[h]=C<<8|C>>>24;p[h]=C;m?(m=q^a[a[a[B^q]]],f^=a[a[f]]):m=f=1}})();
var h=[0,1,2,4,8,16,32,64,128,27,54],s=f.AES=m.extend({_doReset:function(){for(var a=this._key,c=a.words,m=a.sigBytes/4,a=4*((this._nRounds=m+6)+1),f=this._keySchedule=[],g=0;g<a;g++)if(g<m)f[g]=c[g];else{var k=f[g-1];g%m?m>6&&4==g%m&&(k=t[k>>>24]<<24|t[k>>>16&255]<<16|t[k>>>8&255]<<8|t[k&255]):(k=k<<8|k>>>24,k=t[k>>>24]<<24|t[k>>>16&255]<<16|t[k>>>8&255]<<8|t[k&255],k^=h[g/m|0]<<24);f[g]=f[g-m]^k}c=this._invKeySchedule=[];for(m=0;m<a;m++){g=a-m;var k=g%4?f[g]:f[g-4],q;0==m?q=b[t[k>>>24]]^d[t[k>>>16&255]]^l[t[k>>>8&255]]^p[t[k&255]]^f[g-4]:q=b[t[k>>>24]]^d[t[k>>>16&255]]^l[t[k>>>8&255]]^p[t[k&255]];c[m]=q}},encryptBlock:function(a,c){this._doCryptBlock(a,c,this._keySchedule,e,g,k,n,t)},decryptBlock:function(a,c){var m=a[c+1];a[c+1]=a[c+3];a[c+3]=m;this._doCryptBlock(a,c,this._invKeySchedule,b,d,l,p,r);m=a[c+1];a[c+1]=a[c+3];a[c+3]=m},_doCryptBlock:function(a,c,m,f,h,g,k,n,b){for(var d=this._nRounds,l=a[c]^m[0],p=a[c+1]^m[1],q=a[c+2]^m[2],r=a[c+3]^m[3],e=4,t=1;t<d;t++)var s=f[l>>>24]^h[p>>>16&255]^g[q>>>8&255]^k[r&255]^m[e++],u=f[p>>>24]^h[q>>>16&255]^g[r>>>8&255]^k[l&255]^m[e++],v=f[q>>>24]^h[r>>>16&255]^g[l>>>8&255]^k[p&255]^m[e++],w=f[r>>>24]^h[l>>>16&255]^g[p>>>8&255]^k[q&255]^m[e++],l=s,p=u,q=v,r=w;s=(n[l>>>24]<<24|n[p>>>16&255]<<16|n[q>>>8&255]<<8|n[r&255])^m[e++];u=(n[p>>>24]<<24|n[q>>>16&255]<<16|n[q>>>8&255]<<8|n[l&255])^m[e++];v=(n[q>>>24]<<24|n[r>>>16&255]<<16|n[r>>>8&255]<<8|n[p&255])^m[e++];w=(n[r>>>24]<<24|n[l>>>16&255]<<16|n[l>>>8&255]<<8|n[q&255])^m[e++];a[c]=s;a[c+1]=u;a[c+2]=v;a[c+3]=w},keySize:8});a.AES=m}(Math));
</script>

<script>
/* ==================== APP LOGIK ==================== */

/* Exempeldata första gången (du kan ta bort/ändra) */
const SEED=[
  {"title":"Google mail träd","user":"info@tradspecialisterna.se","pass":"Tradfallning1","url":"mail.google.com","note":"Återställning 0738 55 95 23  & info@hedekontorshotell.se"},
  {"title":"One webbhotell (Hemsida)","user":"info@tradspecialisterna.se","pass":"Nvidia8007185716","url":"one.com","note":"Portal för hantering av hemsida"},
  {"title":"One webbhotell","user":"reserv@tradspecialisterna.se","pass":"Jimmy12345","url":"one.com","note":""},
  {"title":"Facebook Trädspecialisterna","user":"info@tradspecialisterna.se","pass":"Tradfallning1","url":"facebook.com","note":""}
];

/* Hjälpare */
const $=s=>document.querySelector(s);
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const te=new TextEncoder(), td=new TextDecoder();
function showErr(msg){const e=$("#err");e.textContent=msg||"";e.style.display=msg?"block":"none";}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&gt;","&quot;":"&quot;","'":"&#39;"}[c]));}
function normalizeUrl(u){if(!u)return"";let s=String(u).trim();if(!s)return"";if(!/^[a-z]+:\\/\\//i.test(s)){if(/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(s))return"mailto:"+s;s="https://"+s;}return s;}
function getHost(u){try{return new URL(normalizeUrl(u)).hostname}catch{const m=String(u||"").match(/^([^\\/:?#]+)(?::\\d+)?/);return m?m[1]:""}}
function favicon(h){return h?`https://icons.duckduckgo.com/ip3/${h}.ico`:""}
function toast(m){const t=document.createElement('div');t.textContent=m;Object.assign(t.style,{position:'fixed',bottom:'18px',left:'50%',transform:'translateX(-50%)',background:'#20242a',border:'1px solid #2a2f36',padding:'10px 14px',borderRadius:'999px',boxShadow:'0 10px 25px rgba(0,0,0,.35)'});document.body.appendChild(t);setTimeout(()=>t.remove(),1700);}

/* Lagring + state */
const VAULT_KEY='vault_v3', SETTINGS_KEY='vault_settings_v3', RECOVERY_BLOB_KEY='vault_recovery_v3';
let MASTER=null, vault={items:[]};
let settings={autoLockMin:5,kdfIter:250000,recoveryEmail:"",recoveryKey:""};
try{settings={...settings,...(JSON.parse(localStorage.getItem(SETTINGS_KEY))||{})}}catch{}
function saveSettings(){localStorage.setItem(SETTINGS_KEY,JSON.stringify(settings));}

/* Kryptering: WebCrypto (AES-GCM) om möjligt, annars CryptoJS (AES-CBC) */
const hasSubtle=!!(crypto&&crypto.subtle);
function b64(a){return btoa(String.fromCharCode(...new Uint8Array(a)))} function ub64(s){return Uint8Array.from(atob(s),c=>c.charCodeAt(0))}
async function deriveKey(pass,salt,iter){const km=await crypto.subtle.importKey('raw',te.encode(pass),'PBKDF2',false,['deriveKey']);return await crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:iter,hash:'SHA-256'},km,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);}
async function encWC(pass,obj,iter=settings.kdfIter){const salt=crypto.getRandomValues(new Uint8Array(16)),iv=crypto.getRandomValues(new Uint8Array(12)),key=await deriveKey(pass,salt,iter),ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,te.encode(JSON.stringify(obj)));return{v:3,a:'wc',iter,salt:b64(salt),iv:b64(iv),ct:b64(ct)}}
async function decWC(pass,blob){const key=await deriveKey(pass,ub64(blob.salt),blob.iter||settings.kdfIter),pt=await crypto.subtle.decrypt({name:'AES-GCM',iv:ub64(blob.iv)},key,ub64(blob.ct));return JSON.parse(td.decode(pt))}
function b64js(w){return CryptoJS.enc.Base64.stringify(CryptoJS.lib.WordArray.create(w))}
function fromB64js(b){return Uint8Array.from(atob(b),c=>c.charCodeAt(0))}
async function encCJS(pass,obj,iter=settings.kdfIter){const salt=crypto.getRandomValues?crypto.getRandomValues(new Uint8Array(16)):new Uint8Array(16).map(()=>Math.random()*256|0);const iv=crypto.getRandomValues?crypto.getRandomValues(new Uint8Array(16)):new Uint8Array(16).map(()=>Math.random()*256|0);const key=CryptoJS.PBKDF2(pass, CryptoJS.lib.WordArray.create(salt), {keySize:256/32,iterations:iter,hasher:CryptoJS.algo.SHA256});const ct=CryptoJS.AES.encrypt(JSON.stringify(obj), key, {iv:CryptoJS.lib.WordArray.create(iv)}).ciphertext;return{v:3,a:'cjs',iter,salt:b64js(salt),iv:b64js(iv),ct:CryptoJS.enc.Base64.stringify(ct)}}
async function decCJS(pass,blob){const salt=fromB64js(blob.salt),iv=fromB64js(blob.iv);const key=CryptoJS.PBKDF2(pass, CryptoJS.lib.WordArray.create(salt), {keySize:256/32,iterations:blob.iter||settings.kdfIter,hasher:CryptoJS.algo.SHA256});const ctW=CryptoJS.enc.Base64.parse(blob.ct);const pt=CryptoJS.AES.decrypt({ciphertext:ctW}, key, {iv:CryptoJS.lib.WordArray.create(iv)});const txt=CryptoJS.enc.Utf8.stringify(pt);if(!txt) throw new Error('bad-pass');return JSON.parse(txt)}
const encVault=(pass,obj)=> hasSubtle?encWC(pass,obj):encCJS(pass,obj);
const decVault=(pass,blob)=> hasSubtle?decWC(pass,blob):decCJS(pass,blob);

async function persist(){
  const blob=await encVault(MASTER,vault);
  localStorage.setItem(VAULT_KEY,JSON.stringify(blob));
  if(settings.recoveryEmail && settings.recoveryKey){
    const r=await encVault(settings.recoveryEmail+'|'+settings.recoveryKey, vault);
    localStorage.setItem(RECOVERY_BLOB_KEY, JSON.stringify(r));
  }
}
async function unlock(pass){
  const raw=localStorage.getItem(VAULT_KEY); if(!raw) throw new Error('no-vault');
  vault = await decVault(pass, JSON.parse(raw)); MASTER=pass; armAutolock();
}
async function createNewVault(pass,email,recoveryKey){
  vault={items:SEED.map(x=>({id:uid(),...x}))};
  MASTER=pass; settings.recoveryEmail=email.trim(); settings.recoveryKey=recoveryKey; saveSettings();
  await persist(); armAutolock();
}

/* Autolås */
let lockTimer=null;
function armAutolock(){clearTimeout(lockTimer);lockTimer=setTimeout(lockNow,Math.max(1,settings.autoLockMin)*60*1000)}
function userActivity(){if(MASTER)armAutolock()}
function lockNow(){MASTER=null;$('#app').setAttribute('aria-hidden','true');showLogin();$('#gate').style.display='flex'}
document.addEventListener('visibilitychange',()=>{if(document.hidden&&MASTER)lockNow()});
['click','keydown','mousemove','touchstart'].forEach(ev=>document.addEventListener(ev,userActivity,{passive:true}));

/* Gate-faser */
const state={phase:'onboarding1',tempKey:''};
function toOnb1(){state.phase='onboarding1';$('#onb').style.display='';$('#recoveryStep').style.display='none';$('#login').style.display='none';$('#primaryBtn').textContent='Skapa valv';showErr('')}
function toOnb2(){state.phase='onboarding2';$('#onb').style.display='none';$('#recoveryStep').style.display='';$('#login').style.display='none';$('#primaryBtn').textContent='Klar & logga in';showErr('')}
function showLogin(){state.phase='login';$('#onb').style.display='none';$('#recoveryStep').style.display='none';$('#login').style.display='';$('#primaryBtn').textContent='Lås upp';showErr('');$('#mp').value=''}

function validateOnboarding(){
  const p1=$('#mp1').value, p2=$('#mp2').value, em=$('#mpEmail').value.trim();
  let ok=true; const set=(el,ok,msgId)=>{el.classList.toggle('error',!ok); if(!ok) showErr(msgId)};
  set($('#mp1'), p1.length>=8, 'Lösenordet måste vara minst 8 tecken.'); ok=ok&&(p1.length>=8);
  set($('#mp2'), p2===p1, 'Lösenorden matchar inte.'); ok=ok&&(p2===p1);
  const emailOk=/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(em); set($('#mpEmail'), emailOk, 'Ogiltig e-postadress.'); ok=ok&&emailOk;
  if(ok) showErr('');
  return ok;
}
function generateRecoveryKey(){
  const dict='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; const r=new Uint32Array(32);
  (crypto.getRandomValues?crypto.getRandomValues(r):(()=>{for(let i=0;i<32;i++)r[i]=Math.random()*4294967296|0;})());
  for(let i=0;i<32;i++) s+=dict[r[i]%dict.length];
  return s.match(/.{1,4}/g).join('-');
}

/* Gate-knappen – robust faslogik */
document.getElementById('primaryBtn').addEventListener('click', async ()=>{
  try{
    if(state.phase==='login'){  // Lås upp
      try{ await unlock($('#mp').value); $('#gate').style.display='none'; $('#app').setAttribute('aria-hidden','false'); render(); }
      catch{ showErr('Fel lösenord.'); }
      return;
    }
    if(state.phase==='onboarding1'){ // Validera & visa nyckel
      if(!validateOnboarding()) return;
      state.tempKey=generateRecoveryKey(); $('#recoveryKey').textContent=state.tempKey; toOnb2(); return;
    }
    if(state.phase==='onboarding2'){ // Skapa valv & in
      await createNewVault($('#mp1').value,$('#mpEmail').value.trim(),state.tempKey);
      $('#gate').style.display='none'; $('#app').setAttribute('aria-hidden','false'); render(); return;
    }
  }catch(e){ console.error(e); showErr('Ett fel inträffade. Försök igen.'); }
});

/* Kopiera/lad­da ned/ma­ila nyckeln */
document.getElementById('copyKey').onclick=()=>{navigator.clipboard?.writeText($('#recoveryKey').textContent||'');toast('Nyckel kopierad')};
document.getElementById('downloadKey').onclick=()=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([($('#recoveryKey').textContent||'')+'\n']));a.download='recovery_key.txt';a.click();setTimeout(()=>URL.revokeObjectURL(a.href),1500)};
document.getElementById('emailKey').onclick=()=>{const addr=$('#mpEmail').value.trim(); if(!addr){toast('Fyll i e-post');return;} const sub=encodeURIComponent('Återställningsnyckel till valv'); const body=encodeURIComponent($('#recoveryKey').textContent||''); location.href=`mailto:${addr}?subject=${sub}&body=${body}`};

/* Återställ-länk & glömt lösenord */
document.getElementById('factoryReset').onclick=(e)=>{e.preventDefault(); if(confirm('Återställ appen? All lokal data tas bort.')){ localStorage.removeItem(VAULT_KEY); localStorage.removeItem(SETTINGS_KEY); localStorage.removeItem(RECOVERY_BLOB_KEY); location.reload(); }};
document.getElementById('forgotBtn').onclick=(e)=>{e.preventDefault(); $('#resetForm').style.display='block'; $('#login').style.display='none'; showErr('');};
document.getElementById('cancelReset').onclick=()=>{$('#resetForm').style.display='none'; $('#login').style.display=''; showErr('');};
document.getElementById('applyReset').onclick=async ()=>{
  const e=$('#resetEmail').value.trim();
  const raw=($('#resetKey').value||'').trim().toUpperCase().replace(/[^A-Z0-9]/g,''); const k=raw.match(/.{1,4}/g)?.join('-')||'';
  const n1=$('#resetNew1').value, n2=$('#resetNew2').value;
  if(!e||!k){showErr('Fyll i e-post och nyckel.');return;}
  if(n1.length<8||n1!==n2){showErr('Nytt lösenord ogiltigt eller matchar inte.');return;}
  try{
    const r=localStorage.getItem(RECOVERY_BLOB_KEY); if(!r) throw new Error('no-rec');
    const recovered = await decVault(e+'|'+k, JSON.parse(r));
    MASTER=n1; vault=recovered; settings.recoveryEmail=e; settings.recoveryKey=k; saveSettings(); await persist();
    $('#resetForm').style.display='none'; $('#gate').style.display='none'; $('#app').setAttribute('aria-hidden','false'); render(); toast('Lösenord återställt');
  }catch{ showErr('Fel e-post/nyckel eller saknas återställningsdata.'); }
};

/* ===== Sök + list ===== */
function score(it,t){let s=0;const a=(it.title||'').toLowerCase(),u=(it.user||'').toLowerCase(),l=(it.url||'').toLowerCase(),n=(it.note||'').toLowerCase();for(const k of t){if(!k)continue;if(a===k)s+=120;if(a.startsWith(k))s+=80;if(a.includes(k))s+=50;if(l.includes(k))s+=35;if(u.includes(k))s+=30;if(n.includes(k))s+=10;}return s;}
document.getElementById('q').addEventListener('input',render);

function render(){
  const q=$('#q').value.trim().toLowerCase(); const toks=q.split(/\s+/).filter(Boolean);
  const arr=(vault.items||[]).map((x,i)=>({_i:i,...x}));
  if(toks.length){arr.sort((A,B)=>{const a=score(A,toks),b=score(B,toks);if((b>0)-(a>0))return (b>0)-(a>0); if(b!==a)return b-a; return A._i-B._i;});}
  const root=$('#cards'); root.innerHTML=''; $('#empty').style.display=arr.length?'none':'block';
  for(const it of arr){
    const host=getHost(it.url||''), fav=favicon(host), url=normalizeUrl(it.url);
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="card-head">
        ${fav?`<img class="favicon" src="${fav}" onerror="this.style.visibility='hidden'">`:`<div class="favicon"></div>`}
        <div style="min-width:0">
          <div style="font-weight:700;overflow-wrap:anywhere">${escapeHtml(it.title||'')}</div>
          <div style="color:#aeb6bf;font-size:12px;overflow-wrap:anywhere">${escapeHtml(it.url||'')}</div>
        </div>
        <span class="badge">Kort</span>
      </div>
      <div class="kv">
        <div class="k">Användare</div><div class="v" style="overflow-wrap:anywhere">${escapeHtml(it.user||'')}</div>
        <div class="k">Lösenord</div>
        <div class="v">
          <input id="pw_${it.id}" type="password" value="${escapeHtml(it.pass||'')}" readonly>
          <div style="display:flex;gap:8px;margin-top:6px">
            <span class="pill" data-act="toggle" data-id="pw_${it.id}">Visa/Dölj</span>
            <span class="pill" data-act="copy" data-id="pw_${it.id}">Kopiera</span>
          </div>
        </div>
        <div class="k">Anteckning</div><div class="v" style="overflow-wrap:anywhere">${escapeHtml(it.note||'')}</div>
      </div>
      <div class="row-actions">
        <span class="pill" data-edit="${it.id}">Redigera</span>
        <span class="pill" data-del="${it.id}" style="background:#261a1a;border-color:#5a2626;color:#ffb3b3">Ta bort</span>
        ${url?`<a class="pill" href="${url}" target="_blank" rel="noopener">Öppna länk</a>`:''}
      </div>`;
    root.appendChild(card);
  }
}

/* List-actions */
document.getElementById('cards').addEventListener('click',e=>{
  const t=e.target;
  if(t.dataset.act==='toggle'){const i=document.getElementById(t.dataset.id);i.type=i.type==='password'?'text':'password';}
  if(t.dataset.act==='copy'){const i=document.getElementById(t.dataset.id);const p=i.type;i.type='text';i.select();document.execCommand('copy');i.type=p;toast('Kopierat!');setTimeout(()=>{navigator.clipboard?.writeText?.('');},15000);}
  if(t.dataset.edit){openModalEdit(t.dataset.edit);}
  if(t.dataset.del){const id=t.dataset.del;if(confirm('Ta bort detta kort?')){vault.items=vault.items.filter(x=>x.id!==id);persist().then(()=>{render();toast('Borttagen');});}}
});

/* Modal nytt/redigera */
const modal={open:()=>$('#modalBackdrop').style.display='flex',close:()=>$('#modalBackdrop').style.display='none'};
document.getElementById('btnAdd').onclick=()=>{$('#modalTitle').textContent='Nytt kort';['title','user','pass','url','note'].forEach(k=>$('#f_'+k).value='');$('#btnSave').dataset.id='';$('#f_pass').type='text';$('#toggleEditPw').textContent='Dölj';modal.open();};
document.getElementById('btnCancel').onclick=()=>modal.close();
function openModalEdit(id){const it=vault.items.find(x=>x.id===id);if(!it)return;$('#modalTitle').textContent='Redigera kort';$('#btnSave').dataset.id=id;$('#f_title').value=it.title||'';$('#f_user').value=it.user||'';$('#f_pass').value=it.pass||'';$('#f_url').value=it.url||'';$('#f_note').value=it.note||'';$('#f_pass').type='text';$('#toggleEditPw').textContent='Dölj';modal.open();}

document.addEventListener('click',e=>{
  if(e.target?.id==='toggleEditPw'){const i=$('#f_pass'); if(i.type==='password'){i.type='text';e.target.textContent='Dölj';}else{i.type='password';e.target.textContent='Visa';}}
  if(e.target?.id==='copyEditPw'){const i=$('#f_pass'); const p=i.type; i.type='text'; i.select(); document.execCommand('copy'); i.type=p; toast('Kopierat!'); setTimeout(()=>{navigator.clipboard?.writeText?.('');},15000);}
  if(e.target?.id==='genPw'){ $('#f_pass').value=genPass(); }
});

document.getElementById('btnSave').onclick=()=>{const id=$('#btnSave').dataset.id||uid();const it={id,title:$('#f_title').value.trim(),user:$('#f_user').value.trim(),pass:$('#f_pass').value,url:$('#f_url').value.trim(),note:$('#f_note').value.trim()};const i=vault.items.findIndex(x=>x.id===id);if(i>=0)vault.items[i]=it;else vault.items.unshift(it);persist().then(()=>{modal.close();render();toast('Sparat');});};

/* Export/Import .vault */
document.getElementById('btnExportVault').onclick=async()=>{if(!MASTER){lockNow();return;}const blob=localStorage.getItem(VAULT_KEY)||'{}';const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([blob],{type:'application/json'}));a.download='losenord.vault';a.click();setTimeout(()=>URL.revokeObjectURL(a.href),1500);toast('Exporterade .vault');};
document.getElementById('btnImportVault').addEventListener('click',()=>document.getElementById('fileVault').click());
document.getElementById('fileVault').addEventListener('change',async ev=>{const f=ev.target.files[0];if(!f)return;try{const obj=JSON.parse(await f.text());if(!obj.ct){alert('Ogiltig vault-fil');return;}localStorage.setItem(VAULT_KEY,JSON.stringify(obj));lockNow();toast('Vault importerad – logga in.');}catch{alert('Kunde inte läsa filen');}});

/* Lås / generator */
document.getElementById('btnLock').onclick=()=>lockNow();
function genPass(len=20){const chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+[]{};:,.?';let out='';const r=new Uint32Array(len);(crypto.getRandomValues?crypto.getRandomValues(r):(()=>{for(let i=0;i<len;i++)r[i]=Math.random()*4294967296|0;})());for(let i=0;i<len;i++) out+=chars[r[i]%chars.length];return out;}

/* Init */
window.addEventListener('load',()=>{
  $('#app').setAttribute('aria-hidden','true'); $('#gate').style.display='flex';
  if(localStorage.getItem(VAULT_KEY)) showLogin(); else toOnb1();
});
</script>
</body>
</html>